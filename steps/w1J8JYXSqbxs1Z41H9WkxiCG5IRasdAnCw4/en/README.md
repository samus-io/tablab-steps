# Same-Origin Policy exceptions

* There are some exceptions to avoid the `SOP` policy where the interaction between two different origins is more invasive.

## Cross-origin script API

* `Cross-origin script API` refers to the ability of web documents coming from different origins to interact and reference each other through certain interfaces provided by JavaScript.
* Some of the methods and attributes that allow this interaction between two different origins are:
  |Read|Write|Read and Write|
  |:--:|:--:|:--:|
  |`window.opener`, `window.closed`, `window.close`, `window.frames`, `window.length`, `window.top`, `window.self`, `window.window`, `window.parent`, `window.blur`, `window.focus`, `window.postMessage`, `location.replace`|`location.href`|`window.location`|

### window.location

* A document can modify the `location` property of another document as long as they have some relation (it is included by means of an `iframe` or another document is opened with the `window.open` action). In this way, it is not possible to read the response of the other document (unless they have the same origin) but it is possible to change its location.
* If we have that the origin `https://domain.tbl` includes by an `iframe` the origin `https://example.tbl`, the second origin can modify the `window.location` property and redirect the users to other pages:

  ```html
  <script>
    window.parent.location = "https://login.example.tbl";
  </script>
  ```

* This code snippet will redirect users from the origin `https://domain.tbl` to `https://example.tbl`.

### document.domain

* A document can modify the `document.domain` property as long as it is changed to a top-level domain.
* If we have the origin `https://www.domain.tbl` this can partially change its origin to `https://domain.tbl` by means of the `document.domain` property.

### Cross-Window Messaging

* HTML5 allows a feature called `Cross-Window Messaging` that enables communication between different documents that are generated by `iframe` or `popups`.
* By using this feature, two windows that have some kind of relationship can exchange messages, such as:
  * A document includes an `iframe`.
  * A document opens a new window using HTML code.
* A document can send messages to another document using the `postMessage` function allowing them to interact with each other.
* An example of JavaScript code used to get a message through `postMessage`:

  ```javascript
  window.addEventListener("message", (event) => {
  let value = "none";

  if (event.origin != "https://domain.tbl") {
  // Origin not trusted
  return;
  }

  if (event.data) {
   value = event.data;
  }
  
  document.write(value);
  }, false);
  ```

* This function can generate `Cross-Site Scripting (XSS)` vulnerabilities that may not be contemplated. To avoid this vulnerability there are two options, either sanitize the user input (which in this case is the message received by the function) or check that the origin from which the message is sent is a trusted origin.
* :warning: It is recommended that in addition to checking the origin, the user input is also filtered.

## Cross-Origin Resource Sharing (CORS)

* Cross-Origin Resource Sharing (CORS) is an HTTP mechanism defined in the server headers that allows you to bypass the `SOP` in order to access the response from an origin.
